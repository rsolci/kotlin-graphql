<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>GraphQL Subscriptions</title>
    <style>
        body {
            font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
            font-weight: 300;
        }

        .stockTicker {
            border: solid black 1px;
            margin: 2px;
            min-height: 400px
        }

        .stockWrapper {
            display: block;
            padding: 20px;
            font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
            font-weight: 300;
        }

        .stockSymbol {
            font-weight: 600;
        }

        .stockPrice {
            font-weight: 600;
            color: red;
        }

        .stockUp {
            font-weight: 600;
            color: green;
        }

        .networking {
            visibility: hidden;
        }
    </style>
    <script>

        function networkBlip() {

            var netIcon = document.querySelector(".networking");
            if (getComputedStyle(netIcon).visibility == 'hidden') {
                netIcon.style.visibility = 'visible';
                setTimeout(function() {
                    netIcon.style.visibility = 'hidden';
                }, 300)
            }
        }

        function subscribeToStocks() {
            var exampleSocket = new WebSocket("ws://localhost:8080/subscriptions");
            networkBlip();

            exampleSocket.onopen = function () {
                networkBlip();
                console.log("web socket opened");

                var query = 'subscription PurchaseSubscription { \n' +
                    '    latestPurchases {' +
                    '       id\n' +
                    '       amount\n' +
                    '       customerId\n' +
                    '       createdAt\n' +
                    '     }' +
                    '}';
                var graphqlMsg = {
                    query: query,
                    variables: {}
                };
                exampleSocket.send(JSON.stringify(graphqlMsg));
            };

            exampleSocket.onmessage = function (event) {
                networkBlip();

                var data = JSON.parse(event.data);
                var msg = data.data.latestPurchases;
                var purchases = msg;

                var htmlStr = '';
                htmlStr += '<div class="">';
                purchases.forEach(function (purchase) {
                    htmlStr += '<span class="stockPrice">' + purchase.id + '</span>';
                    htmlStr += '</div>';
                });
                document.querySelector('.stockTicker').innerHTML = htmlStr
            };
        }

        window.addEventListener("load", subscribeToStocks);
    </script>
</head>
<body>

<div class="container">
    <div class="row">
        <div class="col-sm-8">
            <h3>Stock Price Updates</h3>
            <div class="stockTicker"><span>Pending subscription...</span></div>
            <div class="networking">ðŸ“¡</div>
        </div>
    </div>
</div>
</body>
</html>
